<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Calibration-curves-estimated-with-loess-smoothers • calibmsm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibration-curves-estimated-with-loess-smoothers">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">calibmsm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/BLR-IPCW-manual-bootstrap.html">BLR-IPCW-manual-bootstrap</a></li>
    <li><a class="dropdown-item" href="../articles/Calibration-curves-estimated-with-loess-smoothers.html">Calibration-curves-estimated-with-loess-smoothers</a></li>
    <li><a class="dropdown-item" href="../articles/Comparison-in-competing-risks-setting.html">Comparison-in-competing-risks-setting</a></li>
    <li><a class="dropdown-item" href="../articles/Directory-of-vignettes.html">A catalogue of links and descriptions for the vignettes/articles</a></li>
    <li><a class="dropdown-item" href="../articles/Overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/Sensitivity-analysis-for-IPCWs.html">Sensitivity-analyses-for-IPCWs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Calibration-curves-estimated-with-loess-smoothers</h1>
            
      

      <div class="d-none name"><code>Calibration-curves-estimated-with-loess-smoothers.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="data-preperation">Data preperation<a class="anchor" aria-label="anchor" href="#data-preperation"></a>
</h2>
<p>This vignette showcases how to estimate BLR-IPCW and pseudo-value
calibration curves when using loess smoothers for the model to estimate
the observed event probabilities. This is in contrast to using
restricted cubic splines, which was done so in the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>. Both approaches are viable and we refer to the literature
for a discussion of each method <span class="citation">(Austin, Harrell,
and Klaveren 2020; Harrell 2015)</span>. We mimic exactly the analysis
from the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>, specifying loess smoother rather than restricted cubic
splines, and assess whether the conclusions would be any different. This
is primarily to showcase the utility of the package.</p>
<p>We use data from the European Society for Blood and Marrow
Transplantation <span class="citation">(EBMT 2023)</span>, which
contains multistate survival data after a transplant for patients with
blood cancer. The start of follow up is the day of the transplant and
the initial state is alive and in remission. There are three
intermediate events
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math>:
recovery,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>3</mn><annotation encoding="application/x-tex">3</annotation></semantics></math>:
adverse event, or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>:
recovery + adverse event), and two absorbing states
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>:
relapse and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>6</mn><annotation encoding="application/x-tex">6</annotation></semantics></math>:
death). This data was originally made available from the
<code>mstate</code> package <span class="citation">(Wreede, Fiocco, and
Putter 2011)</span>.</p>
<p>We start by reminding ourselves of the EBMT <span class="citation">(Wreede, Fiocco, and Putter 2011; EBMT 2023)</span>
validation datasets <code>ebmtcal</code> and <code>msebmtcal</code>, and
the predicted transition probabilities out of state <code>j = 1</code>
made at time <code>s = 0</code> from the multistate model
(<code>tps0</code>). We also set the time at which we want to evaluate
the transition probabilities <code>t</code>. Please refer to the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a> for a more detailed description of this data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://alexpate30.github.io/calibmsm/">calibmsm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ebmtcal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ebmtcal</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id  rec rec.s   ae ae.s recae recae.s  rel rel.s  srv srv.s      year agecl</span></span>
<span><span class="co">#&gt; 1  1   22     1  995    0   995       0  995     0  995     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 2  2   29     1   12    1    29       1  422     1  579     1 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 3  3 1264     0   27    1  1264       0 1264     0 1264     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 4  4   50     1   42    1    50       1   84     1  117     1 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 5  5   22     1 1133    0  1133       0  114     1 1133     0 1995-1998   &gt;40</span></span>
<span><span class="co">#&gt; 6  6   33     1   27    1    33       1 1427     0 1427     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt;   proph              match dtcens dtcens_s</span></span>
<span><span class="co">#&gt; 1    no no gender mismatch    995        1</span></span>
<span><span class="co">#&gt; 2    no no gender mismatch    422        0</span></span>
<span><span class="co">#&gt; 3    no no gender mismatch   1264        1</span></span>
<span><span class="co">#&gt; 4    no    gender mismatch     84        0</span></span>
<span><span class="co">#&gt; 5    no    gender mismatch    114        0</span></span>
<span><span class="co">#&gt; 6    no no gender mismatch   1427        1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"msebmtcal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">msebmtcal</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id from to trans Tstart Tstop time status</span></span>
<span><span class="co">#&gt; 1  1    1  2     1      0    22   22      1</span></span>
<span><span class="co">#&gt; 2  1    1  3     2      0    22   22      0</span></span>
<span><span class="co">#&gt; 3  1    1  5     3      0    22   22      0</span></span>
<span><span class="co">#&gt; 4  1    1  6     4      0    22   22      0</span></span>
<span><span class="co">#&gt; 5  1    2  4     5     22   995  973      0</span></span>
<span><span class="co">#&gt; 6  1    2  5     6     22   995  973      0</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"tps0"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tps0</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id   pstate1   pstate2    pstate3   pstate4   pstate5   pstate6        se1</span></span>
<span><span class="co">#&gt; 1  1 0.1139726 0.2295006 0.08450376 0.2326861 0.1504855 0.1888514 0.01291133</span></span>
<span><span class="co">#&gt; 2  2 0.1140189 0.2316569 0.08442692 0.2328398 0.1481977 0.1888598 0.01291552</span></span>
<span><span class="co">#&gt; 3  3 0.1136646 0.2317636 0.08274331 0.2325663 0.1504787 0.1887834 0.01289444</span></span>
<span><span class="co">#&gt; 4  4 0.1383878 0.1836189 0.07579429 0.2179331 0.1538475 0.2304185 0.01857439</span></span>
<span><span class="co">#&gt; 5  5 0.1233226 0.1609740 0.05508100 0.1828176 0.1425950 0.3352099 0.01944967</span></span>
<span><span class="co">#&gt; 6  6 0.1136646 0.2317636 0.08462424 0.2305854 0.1505534 0.1888087 0.01289444</span></span>
<span><span class="co">#&gt;          se2        se3        se4        se5        se6 j</span></span>
<span><span class="co">#&gt; 1 0.02369584 0.01257251 0.02323376 0.01648630 0.01601795 1</span></span>
<span><span class="co">#&gt; 2 0.02374329 0.01256056 0.02324869 0.01632797 0.01603703 1</span></span>
<span><span class="co">#&gt; 3 0.02375770 0.01245752 0.02322375 0.01647890 0.01601525 1</span></span>
<span><span class="co">#&gt; 4 0.03004447 0.01462570 0.03018673 0.02124071 0.02416121 1</span></span>
<span><span class="co">#&gt; 5 0.03419721 0.01367768 0.03423941 0.02329644 0.03688586 1</span></span>
<span><span class="co">#&gt; 6 0.02375770 0.01257276 0.02317348 0.01649531 0.01602438 1</span></span>
<span></span>
<span><span class="va">t_eval</span> <span class="op">&lt;-</span> <span class="fl">1826</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="estimation-of-calibration-curves-out-of-state-j-1-at-time-s-0-using-loess-smoothers">Estimation of calibration curves out of state j = 1 at time s = 0
using loess smoothers<a class="anchor" aria-label="anchor" href="#estimation-of-calibration-curves-out-of-state-j-1-at-time-s-0-using-loess-smoothers"></a>
</h2>
<p>We now produce calibration curves for the predicted transition
probabilities out of state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j = 1</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">s = 0</annotation></semantics></math>.
Given all individuals start in state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>1</mn><annotation encoding="application/x-tex">1</annotation></semantics></math>,
there is no need to consider the transition probabilities out of states
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>≠</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j \neq 1</annotation></semantics></math>
at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">s = 0</annotation></semantics></math>.
Calibration is assessed at follow up time
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>1826</mn></mrow><annotation encoding="application/x-tex">t = 1826</annotation></semantics></math>
days). We start by extracting the predicted transition probabilities
from state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j = 1</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">s = 0</annotation></semantics></math>
from the object . These are the transition probabilities we aim to
assess the calibration of.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tp_pred_s0</span> <span class="op">&lt;-</span> <span class="va">tps0</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">j</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu">any_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pstate"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now produce calibration curves using loess smoothers for the
regression model where the observed event probabilities are estimated.
This is specified by . Behaviour of the curve can be controlled using
and , which we leave as default in this example. Please refere to
documentation for the function from the package for details of these
parameters. A smaller span and/or degree will create a more smoother
line. This is done for both the BLR-IPCW and pseudo-value calibration
curves.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_calib_blr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">0</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'blr'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           w_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>           CI_R_boot <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 1 </span></span>
<span><span class="co">#&gt;  THERE ARE  85  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 0.835</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 2 </span></span>
<span><span class="co">#&gt;  THERE ARE  125  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.205</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 3 </span></span>
<span><span class="co">#&gt;  THERE ARE  133  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.29</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 4 </span></span>
<span><span class="co">#&gt;  THERE ARE  115  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.025</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 5 </span></span>
<span><span class="co">#&gt;  THERE ARE  117  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.16</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 6 </span></span>
<span><span class="co">#&gt;  THERE ARE  111  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.115</span></span>
<span></span>
<span><span class="va">dat_calib_pv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">0</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'pv'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           pv_group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>,</span>
<span>           pv_n_pctls <span class="op">=</span> <span class="fl">3</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">'parametric'</span><span class="op">)</span></span></code></pre></div>
<p>We now produce calibration plots using the function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_blr</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_pv</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<p>The equivalent Figures from the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>, produced using restricted cubic splines, are Figures 2 and
3.</p>
<p>Write a short comparison… XXXX</p>
</div>
<div class="section level2">
<h2 id="estimation-of-calibration-curves-out-of-state-j-1-at-time-s-100-using-loess-smoothers">Estimation of calibration curves out of state j = 1 at time s = 100
using loess smoothers<a class="anchor" aria-label="anchor" href="#estimation-of-calibration-curves-out-of-state-j-1-at-time-s-100-using-loess-smoothers"></a>
</h2>
<p>We now produce calibration curves for the predicted transition
probabilities out of state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j = 1</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">s = 100</annotation></semantics></math>.
Calibration is assessed at follow up time
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>1826</mn></mrow><annotation encoding="application/x-tex">t = 1826</annotation></semantics></math>
days). We start by extracting the predicted transition probabilities
from state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j = 1</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">s = 100</annotation></semantics></math>
from the object . These are the transition probabilities we aim to
assess the calibration of.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tp_pred_s100</span> <span class="op">&lt;-</span> <span class="va">tps100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">j</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu">any_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pstate"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now produce calibration curves using loess smoothers for the
regression model where the observed event probabilities are estimated.
This is specified by . Behaviour of the curve can be controlled using
and , which we leave as default in this example. Please refere to
documentation for the function from the package for details of these
parameters. A smaller span and/or degree will create a more smoother
line. This is done for both the BLR-IPCW and pseudo-value calibration
curves.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_calib_blr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">100</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s100</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'blr'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           w_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>           CI_R_boot <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in calib_msm(data_ms = msebmtcal, data_raw = ebmtcal, j = 1, s = 100, : In the landmark cohort of individuals uncensored and in state j at time s,</span></span>
<span><span class="co">#&gt;     there are some states have less than 50 people at the time at which calibration is being assessed (t).</span></span>
<span><span class="co">#&gt;     Warnings and errors may occur when the models are fitted to estimate the calibration curves due to small sample size.</span></span>
<span><span class="co">#&gt;     This warning has been written to try and intercept some uninformative error messages when the underlying statistical models fail.</span></span>
<span><span class="co">#&gt;     The number to flag this warning (50) has been chosen arbitrarily, and does not constitute a sufficient sample size from a statistical point of view.</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 1 </span></span>
<span><span class="co">#&gt;  THERE ARE  124  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.105</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 2 </span></span>
<span><span class="co">#&gt;  THERE ARE  120  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.205</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 5 </span></span>
<span><span class="co">#&gt;  THERE ARE  99  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 0.955</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 6 </span></span>
<span><span class="co">#&gt;  THERE ARE  140  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.375</span></span>
<span></span>
<span><span class="va">dat_calib_pv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">100</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s100</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'pv'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           pv_group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">'parametric'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in calib_msm(data_ms = msebmtcal, data_raw = ebmtcal, j = 1, s = 100, : In the landmark cohort of individuals uncensored and in state j at time s,</span></span>
<span><span class="co">#&gt;     there are some states have less than 50 people at the time at which calibration is being assessed (t).</span></span>
<span><span class="co">#&gt;     Warnings and errors may occur when the models are fitted to estimate the calibration curves due to small sample size.</span></span>
<span><span class="co">#&gt;     This warning has been written to try and intercept some uninformative error messages when the underlying statistical models fail.</span></span>
<span><span class="co">#&gt;     The number to flag this warning (50) has been chosen arbitrarily, and does not constitute a sufficient sample size from a statistical point of view.</span></span></code></pre></div>
<p>We now produce calibration plots using the function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_blr</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_pv</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<p>The equivalent Figures from the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>, produced using restricted cubic splines, are Figures 5 and
6.</p>
<p>Write a short comparison…</p>
</div>
<div class="section level2">
<h2 id="estimation-of-calibration-curves-out-of-state-j-3-at-time-s-100-using-loess-smoothers">Estimation of calibration curves out of state j = 3 at time s = 100
using loess smoothers<a class="anchor" aria-label="anchor" href="#estimation-of-calibration-curves-out-of-state-j-3-at-time-s-100-using-loess-smoothers"></a>
</h2>
<p>We now produce calibration curves for the predicted transition
probabilities out of state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j = 3</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">s = 100</annotation></semantics></math>.
Calibration is assessed at follow up time
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>1826</mn></mrow><annotation encoding="application/x-tex">t = 1826</annotation></semantics></math>
days). We start by extracting the predicted transition probabilities
from state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">j = 3</annotation></semantics></math>
at time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">s = 100</annotation></semantics></math>
from the object . These are the transition probabilities we aim to
assess the calibration of.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tp_pred_s100</span> <span class="op">&lt;-</span> <span class="va">tps100</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">j</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu">any_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pstate"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now produce calibration curves using loess smoothers for the
regression model where the observed event probabilities are estimated.
This is specified by . Behaviour of the curve can be controlled using
and , which we leave as default in this example. Please refere to
documentation for the function from the package for details of these
parameters. A smaller span and/or degree will create a more smoother
line. This is done for both the BLR-IPCW and pseudo-value calibration
curves.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_calib_blr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">3</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">100</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s100</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'blr'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           w_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>           CI_R_boot <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in calib_msm(data_ms = msebmtcal, data_raw = ebmtcal, j = 3, s = 100, : In the landmark cohort of individuals uncensored and in state j at time s,</span></span>
<span><span class="co">#&gt;     there are some states have less than 50 people at the time at which calibration is being assessed (t).</span></span>
<span><span class="co">#&gt;     Warnings and errors may occur when the models are fitted to estimate the calibration curves due to small sample size.</span></span>
<span><span class="co">#&gt;     This warning has been written to try and intercept some uninformative error messages when the underlying statistical models fail.</span></span>
<span><span class="co">#&gt;     The number to flag this warning (50) has been chosen arbitrarily, and does not constitute a sufficient sample size from a statistical point of view.</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 3 </span></span>
<span><span class="co">#&gt;  THERE ARE  124  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.165</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 4 </span></span>
<span><span class="co">#&gt;  THERE ARE  116  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.15</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 5 </span></span>
<span><span class="co">#&gt;  THERE ARE  121  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.23</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 6 </span></span>
<span><span class="co">#&gt;  THERE ARE  112  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.07</span></span>
<span></span>
<span><span class="va">dat_calib_pv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">3</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">100</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s100</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'pv'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           pv_group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">'parametric'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in calib_msm(data_ms = msebmtcal, data_raw = ebmtcal, j = 3, s = 100, : In the landmark cohort of individuals uncensored and in state j at time s,</span></span>
<span><span class="co">#&gt;     there are some states have less than 50 people at the time at which calibration is being assessed (t).</span></span>
<span><span class="co">#&gt;     Warnings and errors may occur when the models are fitted to estimate the calibration curves due to small sample size.</span></span>
<span><span class="co">#&gt;     This warning has been written to try and intercept some uninformative error messages when the underlying statistical models fail.</span></span>
<span><span class="co">#&gt;     The number to flag this warning (50) has been chosen arbitrarily, and does not constitute a sufficient sample size from a statistical point of view.</span></span></code></pre></div>
<p>We now produce calibration plots using the function.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_blr</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_pv</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<p>The equivalent Figures from the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>, produced using restricted cubic splines, are Figures 7 and
8.</p>
<p>Write a short comparison… XXXX</p>
</div>
<div class="section level2">
<h2 id="a-note-on-the-fact-that-confidence-intervals-may-be-lower-than-0-or-bigger-than-1">A note on the fact that confidence intervals may be lower than 0 or
bigger than 1<a class="anchor" aria-label="anchor" href="#a-note-on-the-fact-that-confidence-intervals-may-be-lower-than-0-or-bigger-than-1"></a>
</h2>
<p>Given the standard error is calculated on the probability scale here,
as opposed to the logit scale, the confidence intervals may exceed 0 and
1. I have checked and the confidence intervals are calculated in the
same way in the CalibrationCurves package: <a href="https://cran.r-project.org/web/packages/CalibrationCurves/CalibrationCurves.pdf" class="external-link uri">https://cran.r-project.org/web/packages/CalibrationCurves/CalibrationCurves.pdf</a>
. In particular see code for val.prob.ci.2: <a href="https://github.com/BavoDC/CalibrationCurves/blob/master/R/val.prob.ci.2.R" class="external-link uri">https://github.com/BavoDC/CalibrationCurves/blob/master/R/val.prob.ci.2.R</a>
. There parametric confidence intervals are calculated in the same way
we calculate parametric confidence intervals for the pseudo value
approach. I am therefore confident this is correct, but is something i’d
like to come back to and consider the implications of. It’s also
intriguing that even for the bootstrapped BLR-IPCW confidence intervals,
we are seeing confidence intervals well outside 0 and 1. I thought this
would be an issue for the pseudo-value parametric confidence intervals
as we are just adding on 1.96*se on the probability scale. However, I
didnt actually think that would be possible for the bootstrapped
confidence intervals, as in any given bootstrapped dataset,
predicted-observed values would still lie between 0 and 1, so this is
something to explore in more detail.</p>
<p>Having done a bit more research (see test_loess_bootstrap.R in the
test folder), the values below 0 are driven by a small number of
individuals with the smallest risks. Lots of their predicted-observed
values are NAs, and they have some negative values too. It is evident
these small number of individuals are driving all the NA values we are
finding in each bootstrap iteration. Going to try increasing the span to
see if that helps. Now i know the mechanism, although not something I’m
particularly worried about, as seems to be driven by small sample size
when assessing calibration at time s = 100.</p>
<p>Compare the following graphs to figures 1 and 2 above. First do .</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_calib_blr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">0</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'blr'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           loess_span <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>           w_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>           CI_R_boot <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 1 </span></span>
<span><span class="co">#&gt;  THERE ARE  94  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 0.91</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 2 </span></span>
<span><span class="co">#&gt;  THERE ARE  118  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.16</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 3 </span></span>
<span><span class="co">#&gt;  THERE ARE  116  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 0.95</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 4 </span></span>
<span><span class="co">#&gt;  THERE ARE  119  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.135</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 5 </span></span>
<span><span class="co">#&gt;  THERE ARE  131  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.315</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 6 </span></span>
<span><span class="co">#&gt;  THERE ARE  115  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.145</span></span>
<span></span>
<span><span class="va">dat_calib_pv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">0</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'pv'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           loess_span <span class="op">=</span> <span class="fl">0.9</span>,</span>
<span>           pv_group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>,</span>
<span>           pv_n_pctls <span class="op">=</span> <span class="fl">3</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">'parametric'</span><span class="op">)</span></span></code></pre></div>
<p>We now produce calibration plots using the function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_blr</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_pv</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<p>Then do .</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat_calib_blr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">0</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'blr'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           loess_span <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           w_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">"bootstrap"</span>,</span>
<span>           CI_R_boot <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 1 </span></span>
<span><span class="co">#&gt;  THERE ARE  86  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 0.805</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 2 </span></span>
<span><span class="co">#&gt;  THERE ARE  130  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.27</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 3 </span></span>
<span><span class="co">#&gt;  THERE ARE  128  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.255</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 4 </span></span>
<span><span class="co">#&gt;  THERE ARE  123  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.125</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 5 </span></span>
<span><span class="co">#&gt;  THERE ARE  132  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.285</span></span>
<span><span class="co">#&gt; Warning in calib_blr_ipcw(data_raw = data_raw, data_ms = data_ms, tp_pred_plot = tp_pred_plot, : WARNING, SOME BOOTSTRAPPED OBSERVED EVENT PROBABILITIES WERE NA FOR STATE 6 </span></span>
<span><span class="co">#&gt;  THERE ARE  112  ITERATIONS WITH NA's </span></span>
<span><span class="co">#&gt;  THE MEAN NUMBER OF NA's IN EACH ITERATION IS 1.02</span></span>
<span></span>
<span><span class="va">dat_calib_pv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>           data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>           j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           s <span class="op">=</span> <span class="fl">0</span>,</span>
<span>           t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>           tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>           calib_type <span class="op">=</span> <span class="st">'pv'</span>,</span>
<span>           curve_type <span class="op">=</span> <span class="st">"loess"</span>,</span>
<span>           loess_span <span class="op">=</span> <span class="fl">1</span>,</span>
<span>           pv_group_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>,</span>
<span>           pv_n_pctls <span class="op">=</span> <span class="fl">3</span>,</span>
<span>           CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>           CI_type <span class="op">=</span> <span class="st">'parametric'</span><span class="op">)</span></span></code></pre></div>
<p>We now produce calibration plots using the function.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_blr</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_pv</span><span class="op">)</span></span>
<span><span class="co">#&gt; TableGrob (2 x 1) "arrange": 2 grobs</span></span>
<span><span class="co">#&gt;   z     cells    name              grob</span></span>
<span><span class="co">#&gt; 1 1 (1-1,1-1) arrange   gtable[arrange]</span></span>
<span><span class="co">#&gt; 2 2 (2-2,1-1) arrange gtable[guide-box]</span></span></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Austin2020" class="csl-entry">
Austin, Peter C., Frank E. Harrell, and David van Klaveren. 2020.
<span>“<span class="nocase">Graphical calibration curves and the
integrated calibration index (ICI) for survival models</span>.”</span>
<em>Statistics in Medicine</em> 39 (21): 2714–42. <a href="https://doi.org/10.1002/sim.8570" class="external-link">https://doi.org/10.1002/sim.8570</a>.
</div>
<div id="ref-EBMT2023" class="csl-entry">
EBMT. 2023. <span>“<span class="nocase">Data from the European Society
for Blood and Marrow Transplantation</span>.”</span> <a href="https://search.r-project.org/CRAN/refmans/mstate/html/EBMT-data.html" class="external-link">https://search.r-project.org/CRAN/refmans/mstate/html/EBMT-data.html</a>.
</div>
<div id="ref-Harrell2015" class="csl-entry">
Harrell, Frank E. 2015. <em><span>Regression Modeling
Strategies</span></em>. Springer S. Cham: Springer.
</div>
<div id="ref-DeWreede2011" class="csl-entry">
Wreede, Liesbeth C de, Marta Fiocco, and Hein Putter. 2011. <span>“<span class="nocase">mstate: An R Package for the Analysis of Competing Risks
and Multi-State Models</span>.”</span> <em>Journal of Statistical
Software</em> 38 (7). <a href="https://cran.r-project.org/package=mstate" class="external-link">https://cran.r-project.org/package=mstate</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Pate, Glen P Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
