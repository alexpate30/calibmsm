<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="calibmsm">
<title>Comparison-with-graphical-calibration-curves-in-competing-risks-setting • calibmsm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Comparison-with-graphical-calibration-curves-in-competing-risks-setting">
<meta property="og:description" content="calibmsm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">calibmsm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/BLR-IPCW-manual-bootstrap.html">BLR-IPCW-manual-bootstrap</a>
    <a class="dropdown-item" href="../articles/Comparison-with-graphical-calibration-curves-in-competing-risks-setting.html">Comparison-with-graphical-calibration-curves-in-competing-risks-setting</a>
    <a class="dropdown-item" href="../articles/Evaluation-of-estimation-of-IPCWs.html">Evaluation-of-estimation-of-IPCWs</a>
    <a class="dropdown-item" href="../articles/overview.html">Overview</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Comparison-with-graphical-calibration-curves-in-competing-risks-setting</h1>
            
      
      
      <div class="d-none name"><code>Comparison-with-graphical-calibration-curves-in-competing-risks-setting.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="data-preperation">Data preperation<a class="anchor" aria-label="anchor" href="#data-preperation"></a>
</h2>
<p>This vignette compares the calibration of a competing risks model
assessed using the approaches provided in <code>calibmsm</code>, namely
the BLR-IPCW and pseudo-value approaches, with graphical calibration
curves developed by <span class="citation">Austin et al. (2022)</span>.
We use data from the European Society for Blood and Marrow
Transplantation <span class="citation">(EBMT 2023)</span>, which
contains multistate survival data after a transplant for patients with
blood cancer. The start of follow up is the day of the transplant and
the initial state is alive and in remission. There are three
intermediate events (<span class="math inline">\(2\)</span>: recovery,
<span class="math inline">\(3\)</span>: adverse event, or <span class="math inline">\(4\)</span>: recovery + adverse event), and two
absorbing states (<span class="math inline">\(5\)</span>: relapse and
<span class="math inline">\(6\)</span>: death). This data was originally
made available from the <code>mstate</code> package <span class="citation">(Wreede, Fiocco, and Putter 2011)</span>. For this
example, we treat the transitions out of the first state as a standalone
competing risks model by setting all subsequent states to be absorbing
states. We are ignoring the subsequent multistate aspect of the
data.</p>
<p>We first load the predicted transition probabilities for each
individual from this model, which are provided in the dataset
<code>tp.cmprsk.j0</code>. The code for deriving this is available in
the source code for the package (see
<code>prepare_vignette_cmprsk_data.R</code>). These are generated by
specifying the transition matrix to define the competing risks model
(i.e. all subsequent states to act as absorbing states), and then
generate predicted risks (cumulative incidence functions) using the
theory of <span class="citation">Putter, Fiocco, and Geskus
(2007)</span>. These are derived using the software in
<code>mstate</code> <span class="citation">(Wreede, Fiocco, and Putter
2011)</span>. Predicted risks were generated for each individual using a
leave-one-out approach (i.e. each individual was removed from the
dataset before fitting the competing risks model and estimating a
predicted risk for that individual). The following four variables were
used to estimate the predicted risks: year of transplant
(<code>year</code>), age at transplant (<code>age</code>), prophylaxis
given (<code>proph</code>), and whether the donor was gender matched
(<code>match</code>).</p>
<p>The transition probabilities are stored in the object
<code>tp.cmprsk.j0</code>. Datasets in formats required for functions
<code>calib_blr</code> and <code>calib_pv</code> are stored in
<code>ebmtcal</code> (<code>data.raw</code> argument) and
<code>msebmtcal.cmprsk</code> (<code>data.mstate</code> argument). Note
that the <code>ebmtcal</code> dataset can still be used as the argument
for <code>data.raw</code>, but a new dataset for the
<code>data.mstate</code> argument is required, which reflects the fact
this is now a competing risks data structure. Please refer to the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a> for more details about how these datasets should be
formatted. We assess calibration at 5 years (1826 days) for all
methods.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://alexpate30.github.io/calibmsm/">calibmsm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"tp.cmprsk.j0"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">tp.cmprsk.j0</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id   pstate1   pstate2   pstate3 pstate4    pstate5    pstate6        se1</span></span>
<span><span class="co">#&gt; 1  1 0.1135057 0.4093590 0.3964498       0 0.02688596 0.05379955 0.01291270</span></span>
<span><span class="co">#&gt; 2  2 0.1135518 0.4114981 0.3942408       0 0.02689840 0.05381085 0.01291690</span></span>
<span><span class="co">#&gt; 3  3 0.1131989 0.4117482 0.3944988       0 0.02681945 0.05373457 0.01289565</span></span>
<span><span class="co">#&gt; 4  4 0.1376981 0.3870386 0.3728509       0 0.04027730 0.06213511 0.01858789</span></span>
<span><span class="co">#&gt; 5  5 0.1227877 0.4277392 0.3496972       0 0.03130458 0.06847131 0.01945048</span></span>
<span><span class="co">#&gt; 6  6 0.1131989 0.4117482 0.3944988       0 0.02681945 0.05373457 0.01289565</span></span>
<span><span class="co">#&gt;          se2        se3 se4         se5         se6</span></span>
<span><span class="co">#&gt; 1 0.01918215 0.01874680   0 0.006339773 0.007719292</span></span>
<span><span class="co">#&gt; 2 0.01920148 0.01870398   0 0.006342388 0.007719937</span></span>
<span><span class="co">#&gt; 3 0.01921355 0.01871733   0 0.006325238 0.007708340</span></span>
<span><span class="co">#&gt; 4 0.02447306 0.02323096   0 0.010698591 0.010818696</span></span>
<span><span class="co">#&gt; 5 0.02777129 0.02476595   0 0.009947925 0.012554747</span></span>
<span><span class="co">#&gt; 6 0.01921355 0.01871733   0 0.006325238 0.007708340</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ebmtcal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ebmtcal</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id  rec rec.s   ae ae.s recae recae.s  rel rel.s  srv srv.s      year agecl</span></span>
<span><span class="co">#&gt; 1  1   22     1  995    0   995       0  995     0  995     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 2  2   29     1   12    1    29       1  422     1  579     1 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 3  3 1264     0   27    1  1264       0 1264     0 1264     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 4  4   50     1   42    1    50       1   84     1  117     1 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 5  5   22     1 1133    0  1133       0  114     1 1133     0 1995-1998   &gt;40</span></span>
<span><span class="co">#&gt; 6  6   33     1   27    1    33       1 1427     0 1427     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt;   proph              match dtcens dtcens.s</span></span>
<span><span class="co">#&gt; 1    no no gender mismatch    995        1</span></span>
<span><span class="co">#&gt; 2    no no gender mismatch    422        0</span></span>
<span><span class="co">#&gt; 3    no no gender mismatch   1264        1</span></span>
<span><span class="co">#&gt; 4    no    gender mismatch     84        0</span></span>
<span><span class="co">#&gt; 5    no    gender mismatch    114        0</span></span>
<span><span class="co">#&gt; 6    no no gender mismatch   1427        1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"msebmtcal.cmprsk"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">msebmtcal.cmprsk</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id from to trans Tstart Tstop time status</span></span>
<span><span class="co">#&gt; 1  1    1  2     1      0    22   22      1</span></span>
<span><span class="co">#&gt; 2  1    1  3     2      0    22   22      0</span></span>
<span><span class="co">#&gt; 3  1    1  5     3      0    22   22      0</span></span>
<span><span class="co">#&gt; 4  1    1  6     4      0    22   22      0</span></span>
<span><span class="co">#&gt; 5  2    1  2     1      0    12   12      0</span></span>
<span><span class="co">#&gt; 6  2    1  3     2      0    12   12      1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="assess-calibration-using-blr-ipcw">Assess calibration using BLR-IPCW<a class="anchor" aria-label="anchor" href="#assess-calibration-using-blr-ipcw"></a>
</h2>
<p>We first assess the calibration of this competing risks model using
the BLR-IPCW approach, implemented through <code>calib_blr</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Estimate calibration curves</span></span>
<span><span class="va">dat.calib.blr</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_blr.html">calib_blr</a></span><span class="op">(</span>data.mstate <span class="op">=</span> <span class="va">msebmtcal.cmprsk</span>,</span>
<span>                 data.raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>                 j<span class="op">=</span><span class="fl">1</span>,</span>
<span>                 s<span class="op">=</span><span class="fl">0</span>,</span>
<span>                 t <span class="op">=</span> <span class="fl">1826</span>,</span>
<span>                 tp.pred <span class="op">=</span> <span class="va">tp.cmprsk.j0</span> <span class="op">|&gt;</span></span>
<span>                   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu">any_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pstate"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 curve.type <span class="op">=</span> <span class="st">"rcs"</span>,</span>
<span>                 rcs.nk <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                 w.covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>                 CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>                 CI.R.boot <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Turn into plot and print</span></span>
<span><span class="va">plot.calibmsm.blr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat.calib.blr</span>, combine <span class="op">=</span> <span class="cn">TRUE</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.calibmsm.blr</span></span></code></pre></div>
<div class="figure">
<img src="Comparison-with-graphical-calibration-curves-in-competing-risks-setting_files/figure-html/unnamed-chunk-4-1.png" alt="Figure 1: Calibration plots for competing risks model out of the starting state when using BLR-IPCW" width="720"><p class="caption">
Figure 1: Calibration plots for competing risks model out of the
starting state when using BLR-IPCW
</p>
</div>
</div>
<div class="section level2">
<h2 id="assess-calibration-using-pseudo-values">Assess calibration using pseudo-values<a class="anchor" aria-label="anchor" href="#assess-calibration-using-pseudo-values"></a>
</h2>
<p>Next we assess the calibration of this competing risks model using
the pseudo-value approach, implemented through
<code>calib_pv</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Estimate calibration curves</span></span>
<span><span class="va">dat.calib.pv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_pv.html">calib_pv</a></span><span class="op">(</span>data.mstate <span class="op">=</span> <span class="va">msebmtcal.cmprsk</span>,</span>
<span>                 data.raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>                 j<span class="op">=</span><span class="fl">1</span>,</span>
<span>                 s<span class="op">=</span><span class="fl">0</span>,</span>
<span>                 t <span class="op">=</span> <span class="fl">1826</span>,</span>
<span>                 tp.pred <span class="op">=</span> <span class="va">tp.cmprsk.j0</span> <span class="op">|&gt;</span></span>
<span>                   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu">any_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pstate"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 curve.type <span class="op">=</span> <span class="st">"rcs"</span>,</span>
<span>                 rcs.nk <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                 group.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span>,</span>
<span>                 n.pctls <span class="op">=</span> <span class="fl">3</span>,</span>
<span>                 CI <span class="op">=</span> <span class="fl">95</span>,</span>
<span>                 CI.type <span class="op">=</span> <span class="st">"parametric"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Turn into plot and print</span></span>
<span><span class="va">plot.calibmsm.pv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat.calib.pv</span>, combine <span class="op">=</span> <span class="cn">TRUE</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.calibmsm.pv</span></span></code></pre></div>
<div class="figure">
<img src="Comparison-with-graphical-calibration-curves-in-competing-risks-setting_files/figure-html/unnamed-chunk-6-1.png" alt="Figure 2: Calibration plots for competing risks model out of the starting state when using pseudo-values" width="720"><p class="caption">
Figure 2: Calibration plots for competing risks model out of the
starting state when using pseudo-values
</p>
</div>
</div>
<div class="section level2">
<h2 id="assess-calibration-using-graphical-calibration-curves">Assess calibration using graphical calibration curves<a class="anchor" aria-label="anchor" href="#assess-calibration-using-graphical-calibration-curves"></a>
</h2>
<p>Finally we assess the calibration of this competing risks model using
the graphical calibration curves approach of <span class="citation">Austin et al. (2022)</span>. A custom function is
written to do this, which estimates the calibration curves and returns a
list of plots using <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc.calib.gcc.mod</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data.mstate</span>, <span class="va">data.raw</span>, <span class="va">j</span>, <span class="va">s</span>, <span class="va">t</span>, <span class="va">p.est</span>, <span class="va">nk</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co">### Assign colnames to p.est</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">p.est</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"p.est"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">p.est</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Extract what states an individual can move into from state j (states with a non-zero predicted risk)</span></span>
<span>  <span class="co">### Also drop the staet that an individual is already in, because there is no cmprsk model for staying in the same state</span></span>
<span>  <span class="va">valid.transitions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">p.est</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">valid.transitions</span> <span class="op">&lt;-</span> <span class="va">valid.transitions</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="va">valid.transitions</span> <span class="op">==</span> <span class="va">j</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co">### Add the predicted risks, and the complementary log log transormation of the predicted risks to data.raw</span></span>
<span>  <span class="va">p.est.cll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p.est</span><span class="op">[</span>,<span class="va">valid.transitions</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">p.est.cll</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"p.est.cll"</span>, <span class="va">valid.transitions</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Identify individuals who are in state j at time s</span></span>
<span>  <span class="va">ids.state.j</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.mstate</span>, <span class="va">from</span> <span class="op">==</span> <span class="va">j</span> <span class="op">&amp;</span> <span class="va">Tstart</span> <span class="op">&lt;=</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">Tstop</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Subset data.mstate and data.raw to these individuals.</span></span>
<span>  <span class="va">data.mstate</span> <span class="op">&lt;-</span> <span class="va">data.mstate</span> <span class="op">|&gt;</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids.state.j</span><span class="op">)</span></span>
<span>  <span class="va">data.raw</span> <span class="op">&lt;-</span> <span class="va">data.raw</span> <span class="op">|&gt;</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids.state.j</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Add the cloglog risks and predicted risks to the landmark dataset</span></span>
<span>  <span class="va">data.raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">data.raw</span>, <span class="va">p.est</span><span class="op">[</span>,<span class="va">valid.transitions</span><span class="op">]</span>, <span class="va">p.est.cll</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Finally, identify individuals which are censored before experiencing any events (used to maniuplate data for Fine-Gray regression later)</span></span>
<span>  <span class="va">ids.cens</span>  <span class="op">&lt;-</span> <span class="va">data.mstate</span> <span class="op">|&gt;</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">from</span> <span class="op">==</span> <span class="va">j</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">sum</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span>     <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">###</span></span>
<span>  <span class="co">### Produce calibration plots for each possible transition</span></span>
<span>  <span class="co">###</span></span>
<span></span>
<span>  <span class="co">### Start by creating a list to store the plots</span></span>
<span>  <span class="va">plots.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">valid.transitions</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">valid.transitions</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>    <span class="co">### Assign state.k</span></span>
<span>    <span class="va">state.k</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">valid.transitions</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Create restricted cubic splines for the cloglog of the linear predictor for the state of interst</span></span>
<span>    <span class="va">rcs.mat</span> <span class="op">&lt;-</span> <span class="fu">Hmisc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Hmisc/man/rcspline.eval.html" class="external-link">rcspline.eval</a></span><span class="op">(</span><span class="va">data.raw</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"p.est.cll"</span>, <span class="va">state.k</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">]</span>,nk<span class="op">=</span><span class="va">nk</span>,inclx<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rcs.mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"rcs.x"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rcs.mat</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>    <span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">rcs.mat</span>,<span class="st">"knots"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Create a new dataframe for the validation, to avoid recurison with data.raw</span></span>
<span>    <span class="co">### Add the cubic splines for thecomplementary loglog of the predicted probability, and the predicted probability itself</span></span>
<span>    <span class="va">valid.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">data.raw</span><span class="op">$</span><span class="va">id</span>, <span class="va">data.raw</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"p.est"</span>, <span class="va">state.k</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">]</span>, <span class="va">rcs.mat</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">valid.df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"pred"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rcs.mat</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Want to validate the competing risks model out of state j at time s, into state k, so remove individuals not in state k at time s,</span></span>
<span>    <span class="co">### and only retain transitions into state k. Also deduct immortal time from time variable</span></span>
<span>    <span class="va">data.mstate.j.k.s</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.mstate</span>, <span class="va">from</span> <span class="op">==</span> <span class="va">j</span> <span class="op">&amp;</span> <span class="va">to</span> <span class="op">==</span> <span class="va">state.k</span> <span class="op">&amp;</span> <span class="va">Tstart</span> <span class="op">&lt;=</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">Tstop</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">Tstop</span> <span class="op">-</span> <span class="va">s</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Add to valid.df</span></span>
<span>    <span class="va">valid.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">valid.df</span>, <span class="va">data.mstate.j.k.s</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### For individuals who do not have the event of interest, and also are not censored (i.e. they have a different competing event),</span></span>
<span>    <span class="co">### set the follow up time to the maximum</span></span>
<span>    <span class="va">valid.df</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">valid.df</span>, time <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">status</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="op">!</span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids.cens</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>,</span>
<span>                                                  <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">time</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Create dataset to fit the recalibration model of Austin et al (Graphical calibration curves, BMC Diagnostic and Prognostic, DOI10.1186/s41512-021-00114-6)</span></span>
<span>    <span class="va">valid.df.crprep</span> <span class="op">&lt;-</span> <span class="fu">mstate</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mstate/man/crprep.default.html" class="external-link">crprep</a></span><span class="op">(</span>Tstop<span class="op">=</span><span class="st">'time'</span>,status<span class="op">=</span><span class="st">'status'</span>,trans<span class="op">=</span><span class="fl">1</span>,</span>
<span>                              keep<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">rcs.mat</span><span class="op">)</span>,<span class="va">valid.df</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Create formula and fit the Fine-Gray recalibration model</span></span>
<span>    <span class="va">eq.LHS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"survival::Surv(Tstart,Tstop,status==1)~"</span><span class="op">)</span></span>
<span>    <span class="va">eq.RHS</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"rcs.x"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rcs.mat</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span></span>
<span>    <span class="va">eq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">eq.LHS</span>, <span class="va">eq.RHS</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">model.calibrate.fg</span> <span class="op">&lt;-</span> <span class="fu">rms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/cph.html" class="external-link">cph</a></span><span class="op">(</span><span class="va">eq</span>,weights<span class="op">=</span><span class="va">weight.cens</span>,x<span class="op">=</span><span class="cn">T</span>,y<span class="op">=</span><span class="cn">T</span>,surv<span class="op">=</span><span class="cn">T</span>,data<span class="op">=</span><span class="va">valid.df.crprep</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Generate predicted probabilities and standard errors</span></span>
<span>    <span class="va">valid.df</span><span class="op">$</span><span class="va">obs.fg</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">-</span><span class="fu">rms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/survest.cph.html" class="external-link">survest</a></span><span class="op">(</span><span class="va">model.calibrate.fg</span>,newdata<span class="op">=</span><span class="va">valid.df.crprep</span>,time<span class="op">=</span><span class="va">t</span><span class="op">-</span><span class="va">s</span><span class="op">)</span><span class="op">$</span><span class="va">surv</span></span>
<span>    <span class="va">valid.df</span><span class="op">$</span><span class="va">obs.fg.upper</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">-</span><span class="fu">rms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/survest.cph.html" class="external-link">survest</a></span><span class="op">(</span><span class="va">model.calibrate.fg</span>,newdata<span class="op">=</span><span class="va">valid.df.crprep</span>,time<span class="op">=</span><span class="va">t</span><span class="op">-</span><span class="va">s</span><span class="op">)</span><span class="op">$</span><span class="va">lower</span></span>
<span>    <span class="va">valid.df</span><span class="op">$</span><span class="va">obs.fg.lower</span><span class="op">&lt;-</span><span class="fl">1</span><span class="op">-</span><span class="fu">rms</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rms/man/survest.cph.html" class="external-link">survest</a></span><span class="op">(</span><span class="va">model.calibrate.fg</span>,newdata<span class="op">=</span><span class="va">valid.df.crprep</span>,time<span class="op">=</span><span class="va">t</span><span class="op">-</span><span class="va">s</span><span class="op">)</span><span class="op">$</span><span class="va">upper</span></span>
<span></span>
<span>    <span class="co">### Produce plots for each and store in a list</span></span>
<span></span>
<span>    <span class="co">### Pivot longer to create data for ggplot and assign appropriate labels</span></span>
<span>    <span class="va">valid.df.longer</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">valid.df</span>, cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">obs.fg</span>, <span class="va">obs.fg.upper</span>, <span class="va">obs.fg.lower</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"line.group"</span><span class="op">)</span></span>
<span>    <span class="va">valid.df.longer</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">valid.df.longer</span>,</span>
<span>                              line.group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">line.group</span><span class="op">)</span>,</span>
<span>                              mapping <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">line.group</span> <span class="op">==</span> <span class="st">"obs.fg"</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                                                  <span class="va">line.group</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"obs.fg.upper"</span>, <span class="st">"obs.fg.lower"</span><span class="op">)</span> <span class="op">~</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                              mapping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">mapping</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">valid.df.longer</span><span class="op">$</span><span class="va">line.group</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Calibration"</span>, <span class="st">"Upper"</span>, <span class="st">"Lower"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">valid.df.longer</span><span class="op">$</span><span class="va">mapping</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Calibration"</span>, <span class="st">"95% CI"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co">### Create the plot</span></span>
<span>    <span class="va">plots.list</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">valid.df.longer</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">pred</span>, <span class="va">line.group</span>, <span class="va">value</span>, <span class="va">mapping</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pred</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="va">line.group</span>, color <span class="op">=</span> <span class="va">mapping</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Predicted risk"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Observed risk"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">valid.df.longer</span><span class="op">$</span><span class="va">pred</span>,</span>
<span>                    <span class="va">valid.df.longer</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">valid.df.longer</span><span class="op">$</span><span class="va">pred</span>,</span>
<span>                    <span class="va">valid.df.longer</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html" class="external-link">geom_rug</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">valid.df.longer</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">pred</span>, <span class="va">line.group</span>, <span class="va">value</span>, <span class="va">mapping</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">line.group</span> <span class="op">==</span> <span class="st">"Calibration"</span><span class="op">)</span>,</span>
<span>                        <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pred</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu">grDevices</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, alpha <span class="op">=</span> <span class="fl">.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"State "</span>, <span class="va">state.k</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">### Return plots</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">plots.list</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function is then applied to estimate the calibration curves and
create the plots.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Estimate calibration curves and create plots</span></span>
<span><span class="va">plot.gcc.rcs.list</span> <span class="op">&lt;-</span> <span class="fu">calc.calib.gcc.mod</span><span class="op">(</span>data.mstate <span class="op">=</span> <span class="va">msebmtcal.cmprsk</span>,</span>
<span>                                    data.raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>                                    j <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                    s <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                    t <span class="op">=</span> <span class="fl">1826</span>,</span>
<span>                                    p.est <span class="op">=</span> <span class="va">tp.cmprsk.j0</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pstate"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                                    nk <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Combine into one plot and print</span></span>
<span><span class="va">plot.gcc.rcs</span> <span class="op">&lt;-</span> <span class="fu">ggpubr</span><span class="fu">::</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">plot.gcc.rcs.list</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.gcc.rcs</span></span></code></pre></div>
<div class="figure">
<img src="Comparison-with-graphical-calibration-curves-in-competing-risks-setting_files/figure-html/unnamed-chunk-9-1.png" alt="Figure 3: Calibration plots for competing risks model out of the starting state when using graphical calibration curves" width="720"><p class="caption">
Figure 3: Calibration plots for competing risks model out of the
starting state when using graphical calibration curves
</p>
</div>
</div>
<div class="section level2">
<h2 id="comarpsion-of-results">Comarpsion of results<a class="anchor" aria-label="anchor" href="#comarpsion-of-results"></a>
</h2>
<p>The calibration of the transition probabilities is similar
irrespective of the method used to assess calibration. This is with the
exception of the calibration of the transition probabilities into state
3 when using the BLR-IPCW approach. Possible reasons for this are
discussed in the <a href="Evaluation-of-estimation-of-IPCWs.html">Evaluation-of-estimation-of-IPCWs
vignette</a>. In practice, it could be worth assessing calibration using
a variety of approaches. If agreement is found, this would provide
reassurance over the assessment of calibration. Note that the graphical
calibration curves approach does not provide a way to assess the
calibration of state 1, hence the difference in the number of plots.</p>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Austin2022" class="csl-entry">
Austin, Peter C., Hein Putter, Daniele Giardiello, and David van
Klaveren. 2022. <span>“<span class="nocase">Graphical calibration curves
and the integrated calibration index (ICI) for competing risk
models</span>.”</span> <em>Diagnostic and Prognostic Research</em> 6
(1). <a href="https://doi.org/10.1186/s41512-021-00114-6" class="external-link">https://doi.org/10.1186/s41512-021-00114-6</a>.
</div>
<div id="ref-EBMT2023" class="csl-entry">
EBMT. 2023. <span>“<span class="nocase">Data from the European Society
for Blood and Marrow Transplantation</span>.”</span> <a href="https://search.r-project.org/CRAN/refmans/mstate/html/EBMT-data.html" class="external-link">https://search.r-project.org/CRAN/refmans/mstate/html/EBMT-data.html</a>.
</div>
<div id="ref-Putter2007" class="csl-entry">
Putter, H, M Fiocco, and R. B. Geskus. 2007. <span>“<span class="nocase">Tutorial in biostatistics: Competing risks and
multi-state models</span>.”</span> <em>Statistics in Medicine</em> 26
(11): 2389–2430. https://doi.org/<a href="https://doi.org/10.1002/sim.2712" class="external-link">https://doi.org/10.1002/sim.2712</a>.
</div>
<div id="ref-DeWreede2011" class="csl-entry">
Wreede, Liesbeth C de, Marta Fiocco, and Hein Putter. 2011. <span>“<span class="nocase">mstate: An R Package for the Analysis of Competing Risks
and Multi-State Models</span>.”</span> <em>Journal of Statistical
Software</em> 38 (7). <a href="https://cran.r-project.org/package=mstate" class="external-link">https://cran.r-project.org/package=mstate</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Alexander Pate, Glen P Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
