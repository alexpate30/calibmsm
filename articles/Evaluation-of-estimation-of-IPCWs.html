<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="calibmsm">
<title>Evaluation-of-estimation-of-IPCWs • calibmsm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Evaluation-of-estimation-of-IPCWs">
<meta property="og:description" content="calibmsm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">calibmsm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/BLR-IPCW-manual-bootstrap.html">BLR-IPCW-manual-bootstrap</a>
    <a class="dropdown-item" href="../articles/Calibration-curves-estimated-with-loess-smoothers.html">Calibration-curves-estimated-with-loess-smoothers</a>
    <a class="dropdown-item" href="../articles/Comparison-in-competing-risks-setting.html">Comparison-in-competing-risks-setting</a>
    <a class="dropdown-item" href="../articles/Directory-of-vignettes.html">A catalogue of links and descriptions for the vignettes/articles</a>
    <a class="dropdown-item" href="../articles/Evaluation-of-estimation-of-IPCWs.html">Evaluation-of-estimation-of-IPCWs</a>
    <a class="dropdown-item" href="../articles/Overview.html">Overview</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Evaluation-of-estimation-of-IPCWs</h1>
            
      
      
      <div class="d-none name"><code>Evaluation-of-estimation-of-IPCWs.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette explores whether the assumptions of the BLR-IPCW and
psuedo-value methods for assessing calibration are met in the
illustrative example in the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>. We use data from the European Society for Blood and Marrow
Transplantation <span class="citation">(EBMT 2023)</span>, which
contains multistate survival data after a transplant for patients with
blood cancer. The start of follow up is the day of the transplant and
the initial state is alive and in remission. There are three
intermediate events (<span class="math inline">\(2\)</span>: recovery,
<span class="math inline">\(3\)</span>: adverse event, or <span class="math inline">\(4\)</span>: recovery + adverse event), and two
absorbing states (<span class="math inline">\(5\)</span>: relapse and
<span class="math inline">\(6\)</span>: death). This data was originally
made available from the <code>mstate</code> package <span class="citation">(Wreede, Fiocco, and Putter 2011)</span>.</p>
<p>In the illustrative example in the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>, we found predominately good agreement between the BLR-IPCW
and pseudo-value calibration curves, except when assessing the
calibration of the transition probabilities from state <span class="math inline">\(j = 1\)</span> into state <span class="math inline">\(k = 3\)</span>. Given we do not know the true
calibration of these transition probabilities we cannot say for sure
which calibration curve is correct. However, we can take steps to test
the assumptions made by each of the methods, which may help guide which
method of assessing calibration should be used in this particular
clinical example. We suggest package users take similar steps to explore
which method may be most appropriate in their particular clinical
context.</p>
</div>
<div class="section level2">
<h2 id="methods-and-results">Methods and Results<a class="anchor" aria-label="anchor" href="#methods-and-results"></a>
</h2>
<p>We start by reminding ourselves of the EBMT <span class="citation">(Wreede, Fiocco, and Putter 2011; EBMT 2023)</span>
validation dataset <code>ebmtcal</code>. Please refer to the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a> for a more detailed description of this data.</p>
<p>BLR-IPCW requires that the outcome, <span class="math inline">\(I_{k}(t)\)</span>, is independent from the
censoring mechanism in the re-weighted population. Psuedo-values require
non-informative censoring within the subgroups within which they are
calculated. A key variable which predicts the censoring mechanism is
year of transplant, <code>year</code>. Individuals who had their
transplant more recently have a shorter administrative censoring time,
given they have a shorter maximum follow up.</p>
<p>When calculating pseudo-values, we can completely remove the impact
of this variable by calculating pseudo-values within subgroups defined
by this variable. In the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a> we also further grouped patients by their predicted risk in
a further three subgroups. We therefore believe the assumption for the
pseudo-value approach is likely to hold.</p>
<p>When implementing the BLR-IPCW approach, the most important step is
estimation of the inverse probability of censoring weights (IPCWs). In
<strong>calibmsm</strong> this is done internally using a cox
proportional hazards model. We fit this model to the
<code>ebmtcal</code> data again here to assess how well it has been
specified.</p>
<p>We start by loading the <code>ebmtcal</code> data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://alexpate30.github.io/calibmsm/">calibmsm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ebmtcal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ebmtcal</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id  rec rec.s   ae ae.s recae recae.s  rel rel.s  srv srv.s      year agecl</span></span>
<span><span class="co">#&gt; 1  1   22     1  995    0   995       0  995     0  995     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 2  2   29     1   12    1    29       1  422     1  579     1 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 3  3 1264     0   27    1  1264       0 1264     0 1264     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 4  4   50     1   42    1    50       1   84     1  117     1 1995-1998 20-40</span></span>
<span><span class="co">#&gt; 5  5   22     1 1133    0  1133       0  114     1 1133     0 1995-1998   &gt;40</span></span>
<span><span class="co">#&gt; 6  6   33     1   27    1    33       1 1427     0 1427     0 1995-1998 20-40</span></span>
<span><span class="co">#&gt;   proph              match dtcens dtcens.s</span></span>
<span><span class="co">#&gt; 1    no no gender mismatch    995        1</span></span>
<span><span class="co">#&gt; 2    no no gender mismatch    422        0</span></span>
<span><span class="co">#&gt; 3    no no gender mismatch   1264        1</span></span>
<span><span class="co">#&gt; 4    no    gender mismatch     84        0</span></span>
<span><span class="co">#&gt; 5    no    gender mismatch    114        0</span></span>
<span><span class="co">#&gt; 6    no no gender mismatch   1427        1</span></span></code></pre></div>
<p>This is followed by fitting a cox model to predict probability of
being censored. This below code chunk is what happens internally in
<code>calib_blr</code> if one sets
<code>w.covs = c("year", "agecl", "proph", "match")</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model.ipcw</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">dtcens</span>, <span class="va">dtcens.s</span><span class="op">)</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">agecl</span> <span class="op">+</span> <span class="va">proph</span> <span class="op">+</span> <span class="va">match</span>, data <span class="op">=</span> <span class="va">ebmtcal</span><span class="op">)</span></span>
<span><span class="va">model.ipcw</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; survival::coxph(formula = survival::Surv(dtcens, dtcens.s) ~ </span></span>
<span><span class="co">#&gt;     year + agecl + proph + match, data = ebmtcal)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;                           coef exp(coef)  se(coef)      z      p</span></span>
<span><span class="co">#&gt; year1990-1994         1.781086  5.936299  0.093909 18.966 &lt;2e-16</span></span>
<span><span class="co">#&gt; year1995-1998         3.796330 44.537437  0.118184 32.122 &lt;2e-16</span></span>
<span><span class="co">#&gt; agecl20-40           -0.135434  0.873337  0.064500 -2.100 0.0357</span></span>
<span><span class="co">#&gt; agecl&gt;40             -0.084436  0.919031  0.080513 -1.049 0.2943</span></span>
<span><span class="co">#&gt; prophyes             -0.072379  0.930179  0.069379 -1.043 0.2968</span></span>
<span><span class="co">#&gt; matchgender mismatch -0.006291  0.993729  0.064812 -0.097 0.9227</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Likelihood ratio test=1351  on 6 df, p=&lt; 2.2e-16</span></span>
<span><span class="co">#&gt; n= 2279, number of events= 1376</span></span></code></pre></div>
<p>The coefficient for <code>year</code>, in particular 1995 - 1998, is
very big. However, we know that year of transplant is likely be to
highly predictive of being censored, so further exploration is needed. A
key assumption made by this model is proportional hazards. We plot the
the cumulative hazard estimate using Kaplan-Meier survival curves
stratified by year of transplant and assess proportionality
visually.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kmfit</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">dtcens</span>, <span class="va">dtcens.s</span><span class="op">)</span> <span class="op">~</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">ebmtcal</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">kmfit</span>, fun <span class="op">=</span> <span class="st">"cumhaz"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, xlab <span class="op">=</span> <span class="st">"Days"</span>, ylab <span class="op">=</span> <span class="st">"Cumulative hazard"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">6.5</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1985 - 1989"</span>, <span class="st">"1990 - 1994"</span>, <span class="st">"1995 - 1998"</span><span class="op">)</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<p class="caption">
Figure 1: Cumulative hazard calculated within subgroups defined by year
of transplant
</p>
<img src="Evaluation-of-estimation-of-IPCWs_files/figure-html/unnamed-chunk-5-1.png" alt="Figure 1: Cumulative hazard calculated within subgroups defined by year of transplant" width="720">
</div>
</div>
<div class="section level2">
<h2 id="discussion">Discussion<a class="anchor" aria-label="anchor" href="#discussion"></a>
</h2>
<p>For the proportional hazards assumption to hold, the Kaplan-Meier
survival curves within in each group should be proprtional to eachother
over every follow up time. Clearly the proportional hazards assumption
does not hold. This means the model for estimating the weights is
misspecified and the estimated IPCWs may be wrong. While the variable
year of transplant could be removed from the model for estimating the
weights to help ensure the proportional hazards assumption is met, we
know this variable is highly predictive of being censored, and therefore
omitting this key predictor would also result in a misspecified model
and incorrect weights.</p>
<p>We would therefore conclude that it is unlikely that the assumptions
hold for the BLR-IPCW method, which could be resulting in biased
calibration curves in this particular clinical example. If developing
this model in practice, we would recommend assessing calibration using
the pseudo-value approach. This is not a fundamental problem with the
BLR-IPCW approach, but an issue with estimating the IPCWs under the
censoring mechanism in this example. If the IPCWs can be estimated
correctly, this should result in unbiased calibration curves. As
suggested in the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>, more simulation studies are required to rigorously test
the robustness of each method when their assumptions do not hold, and in
what scenario each method is most likely to give biased calibration
curves.</p>
<p>This vignette has also highlighted the limitations of using a cox
proportional hazards model to estimate the IPCWs. The
<strong>calibmsm</strong> package has been developed to provide a set of
tools to assess the calibration of multistate models, but is not a
focused package for estimating IPCWs. We urge users to develop better
models for estimating the IPCWs and specify them using the
<code>weights</code> argument. A process for estimating confidence
intervals using bootstrapping when manually estimating the IPCWs is
exemplified in the <a href="BLR-IPCW-manual-boostrap.html">BLR-IPCW-manual-boostrap
vignette</a>.</p>
<p>One final point, it is peculiar that this issue only causes
discordance between the calibration plots out of state <span class="math inline">\(j = 0\)</span> into state <span class="math inline">\(k = 3\)</span>, whereas for all other states <span class="math inline">\(k\)</span> there is closer agreement between the
BLR-IPCW and pseudo-value calibration curves (see Figures 2 and 3 in the
<a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>). We hypothesise that this may be due to the fact no
individuals move into state <span class="math inline">\(3\)</span> after
<span class="math inline">\(100\)</span> days. We believe this is due to
the definition of an adverse event needing to happen within <span class="math inline">\(100\)</span> days post transplant, but cannot be
sure as the authors of this package had no involvement in data
collection. It is possible that the application of incorrectly estimated
weights, in combination with predicted risks of the outcome state which
behaves differently to all others, is the reason behind this behaviour.
However, further exploration of this is beyond the scope of this
vignette.</p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-EBMT2023" class="csl-entry">
EBMT. 2023. <span>“<span class="nocase">Data from the European Society
for Blood and Marrow Transplantation</span>.”</span> <a href="https://search.r-project.org/CRAN/refmans/mstate/html/EBMT-data.html" class="external-link">https://search.r-project.org/CRAN/refmans/mstate/html/EBMT-data.html</a>.
</div>
<div id="ref-DeWreede2011" class="csl-entry">
Wreede, Liesbeth C de, Marta Fiocco, and Hein Putter. 2011. <span>“<span class="nocase">mstate: An R Package for the Analysis of Competing Risks
and Multi-State Models</span>.”</span> <em>Journal of Statistical
Software</em> 38 (7). <a href="https://cran.r-project.org/package=mstate" class="external-link">https://cran.r-project.org/package=mstate</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Pate, Glen P Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
