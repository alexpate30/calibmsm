<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Sensitivity-analyses-for-IPCWs • calibmsm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sensitivity-analyses-for-IPCWs">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">calibmsm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/BLR-IPCW-manual-bootstrap.html">BLR-IPCW-manual-bootstrap</a></li>
    <li><a class="dropdown-item" href="../articles/Calibration-curves-estimated-with-loess-smoothers.html">Calibration-curves-estimated-with-loess-smoothers</a></li>
    <li><a class="dropdown-item" href="../articles/Comparison-in-competing-risks-setting.html">Comparison-in-competing-risks-setting</a></li>
    <li><a class="dropdown-item" href="../articles/Directory-of-vignettes.html">A catalogue of links and descriptions for the vignettes/articles</a></li>
    <li><a class="dropdown-item" href="../articles/Overview.html">Overview</a></li>
    <li><a class="dropdown-item" href="../articles/Sensitivity-analysis-for-IPCWs.html">Sensitivity-analyses-for-IPCWs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/alexpate30/calibmsm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Sensitivity-analyses-for-IPCWs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/alexpate30/calibmsm/blob/master/vignettes/articles/Sensitivity-analysis-for-IPCWs.Rmd" class="external-link"><code>vignettes/articles/Sensitivity-analysis-for-IPCWs.Rmd</code></a></small>
      <div class="d-none name"><code>Sensitivity-analysis-for-IPCWs.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette explores the sensitivty of the BLR-IPCW approach to the
estimation of the weights. The start of follow up is the day of the
transplant and the initial state is alive and in remission. There are
three intermediate events
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>2</mn><annotation encoding="application/x-tex">2</annotation></semantics></math>:
recovery,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>3</mn><annotation encoding="application/x-tex">3</annotation></semantics></math>:
adverse event, or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>4</mn><annotation encoding="application/x-tex">4</annotation></semantics></math>:
recovery + adverse event), and two absorbing states
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>:
relapse and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>6</mn><annotation encoding="application/x-tex">6</annotation></semantics></math>:
death). This data was originally made available from the
<code>mstate</code> package <span class="citation">(Wreede, Fiocco, and
Putter 2011)</span>. Please refer to the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a> for a more detailed description of this data.</p>
<p>This analysis is motivated by the fact that in the illustrative
example in the <a href="https://alexpate30.github.io/calibmsm/articles/overview_vignette.pdf">Overview
vignette</a>, we saw a considerable difference in the estimated
calibration curves from state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j = 1</annotation></semantics></math>
into state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">k = 3</annotation></semantics></math>
when using either BLR-IPCW or pseudo-value approach. While all the other
states show a similar level of calibration when using either method,
which provides reassurance over their validity, this is not the case for
state 3, and further investigation is required. One hypothesis for this
difference is that a cox-proportional hazards model was used to estimate
the weights when implemtning the BLR-IPCW approach, and it’s possible
the proportional hazards assumption does not hold. We will therefore
explore the validity of this assumption, and re-estimate the calibration
curves using a flexible parametric survival model to estimate the
weights.<span class="citation">(Royston and Parmar 2002)</span></p>
</div>
<div class="section level2">
<h2 id="exploring-the-assumption-of-proportional-hazards-in-the-model-for-estimating-the-ipcws">Exploring the assumption of proportional hazards in the model for
estimating the IPCWs<a class="anchor" aria-label="anchor" href="#exploring-the-assumption-of-proportional-hazards-in-the-model-for-estimating-the-ipcws"></a>
</h2>
<p>A key variable which predicts the censoring mechanism is year of
transplant, <code>year</code>. Individuals who had their transplant more
recently have a shorter administrative censoring time, given they have a
shorter maximum follow up. We can view this by looking at the
distribution of maximum follow up time for each individual (this is the
time until either censoring, or entering an absorbing state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>5</mn><annotation encoding="application/x-tex">5</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>6</mn><annotation encoding="application/x-tex">6</annotation></semantics></math>)
stratified by <code>year</code>.</p>
<p>Load libraries and functions:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexpate30/calibmsm" class="external-link">calibmsm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"survminer"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/survminer/index.html" class="external-link">survminer</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: ggpubr</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'survminer'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:survival':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     myeloma</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"flexsurv"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/flexsurv" class="external-link">flexsurv</a></span><span class="op">)</span></span></code></pre></div>
<p>Load data:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"ebmtcal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ebmtcal</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   id  rec rec.s   ae ae.s recae recae.s  rel rel.s  srv srv.s      year agecl</span></span>
<span><span class="co">## 1  1   22     1  995    0   995       0  995     0  995     0 1995-1998 20-40</span></span>
<span><span class="co">## 2  2   29     1   12    1    29       1  422     1  579     1 1995-1998 20-40</span></span>
<span><span class="co">## 3  3 1264     0   27    1  1264       0 1264     0 1264     0 1995-1998 20-40</span></span>
<span><span class="co">## 4  4   50     1   42    1    50       1   84     1  117     1 1995-1998 20-40</span></span>
<span><span class="co">## 5  5   22     1 1133    0  1133       0  114     1 1133     0 1995-1998   &gt;40</span></span>
<span><span class="co">## 6  6   33     1   27    1    33       1 1427     0 1427     0 1995-1998 20-40</span></span>
<span><span class="co">##   proph              match dtcens dtcens_s</span></span>
<span><span class="co">## 1    no no gender mismatch    995        1</span></span>
<span><span class="co">## 2    no no gender mismatch    422        0</span></span>
<span><span class="co">## 3    no no gender mismatch   1264        1</span></span>
<span><span class="co">## 4    no    gender mismatch     84        0</span></span>
<span><span class="co">## 5    no    gender mismatch    114        0</span></span>
<span><span class="co">## 6    no no gender mismatch   1427        1</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"msebmtcal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">msebmtcal</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## An object of class 'msdata'</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Data:</span></span>
<span><span class="co">##   id from to trans Tstart Tstop time status</span></span>
<span><span class="co">## 1  1    1  2     1      0    22   22      1</span></span>
<span><span class="co">## 2  1    1  3     2      0    22   22      0</span></span>
<span><span class="co">## 3  1    1  5     3      0    22   22      0</span></span>
<span><span class="co">## 4  1    1  6     4      0    22   22      0</span></span>
<span><span class="co">## 5  1    2  4     5     22   995  973      0</span></span>
<span><span class="co">## 6  1    2  5     6     22   995  973      0</span></span></code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_eval</span> <span class="op">&lt;-</span> <span class="fl">1826</span></span></code></pre></div>
<p>Look at maximum follow up:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">dtcens</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">year</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre>
<p><img src="Sensitivity-analysis-for-IPCWs_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>When fitting a cox proportional hazards model to estimate the
weights, this will clearly violate the proportional hazards assumption
given there is differential follow up in each group. This is why we
opted to censor all individuals at 5-years follow up (1826 days) before
fitting this model. This is specified through the
<code>w_max_follow</code> argument in <code>calib_msm</code>.</p>
<p>We can calculate the weights here by running the
<code>calc_weights</code> function:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span><span class="op">$</span><span class="va">ipcw_ph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_weights.html">calc_weights</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>, </span>
<span>                                data_raw <span class="op">=</span> <span class="va">ebmtcal</span>, </span>
<span>                                covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>, </span>
<span>                                t <span class="op">=</span> <span class="va">t_eval</span>, s <span class="op">=</span> <span class="fl">0</span>, j <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                max_follow <span class="op">=</span> <span class="va">t_eval</span><span class="op">)</span><span class="op">$</span><span class="va">ipcw</span></span></code></pre></div>
<p>We can view the distribution of these weights:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ipcw_ph</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Removed 501 rows containing non-finite outside the scale range</span></span>
<span><span class="co">## (`stat_bin()`).</span></span></code></pre>
<p><img src="Sensitivity-analysis-for-IPCWs_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>These weights are estimated by fitting the following model:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal_5y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">ebmtcal</span>,</span>
<span>                     dtcens_s <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&gt;</span> <span class="fl">1826</span> <span class="op">~</span> <span class="fl">0</span>,</span>
<span>                                          <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">dtcens_s</span><span class="op">)</span>,</span>
<span>                     dtcens <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&gt;</span> <span class="fl">1826</span> <span class="op">~</span> <span class="fl">1826</span>,</span>
<span>                                        <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">dtcens</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">model_ipcw_ph</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">dtcens</span>, <span class="va">dtcens_s</span><span class="op">)</span> <span class="op">~</span> <span class="va">year</span> <span class="op">+</span> <span class="va">agecl</span> <span class="op">+</span> <span class="va">proph</span> <span class="op">+</span> <span class="va">match</span>, data <span class="op">=</span> <span class="va">ebmtcal_5y</span><span class="op">)</span></span>
<span><span class="va">model_ipcw_ph</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## survival::coxph(formula = survival::Surv(dtcens, dtcens_s) ~ </span></span>
<span><span class="co">##     year + agecl + proph + match, data = ebmtcal_5y)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##                          coef exp(coef) se(coef)      z        p</span></span>
<span><span class="co">## year1990-1994         1.23753   3.44710  0.25132  4.924 8.48e-07</span></span>
<span><span class="co">## year1995-1998         3.21074  24.79734  0.23772 13.506  &lt; 2e-16</span></span>
<span><span class="co">## agecl20-40           -0.08229   0.92101  0.11159 -0.737    0.461</span></span>
<span><span class="co">## agecl&gt;40              0.04593   1.04700  0.12506  0.367    0.713</span></span>
<span><span class="co">## prophyes              0.01612   1.01625  0.11901  0.135    0.892</span></span>
<span><span class="co">## matchgender mismatch -0.06660   0.93557  0.10722 -0.621    0.534</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Likelihood ratio test=617.3  on 6 df, p=&lt; 2.2e-16</span></span>
<span><span class="co">## n= 2279, number of events= 501</span></span></code></pre>
<p>Note there is still a very large hazard-ratio for the year 1995-1998
variable, although this is to be expected given the shorter follow up
times.</p>
<p>Testing the proportional hazards assumption, we find this does not
hold for any of the predictor variables, although <code>year</code> is
no worse than the other variables.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phtest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/cox.zph.html" class="external-link">cox.zph</a></span><span class="op">(</span><span class="va">model_ipcw_ph</span><span class="op">)</span></span>
<span><span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggcoxzph.html" class="external-link">ggcoxzph</a></span><span class="op">(</span><span class="va">phtest</span>, resid <span class="op">=</span> <span class="cn">FALSE</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="Sensitivity-analysis-for-IPCWs_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>We can therefore conclude that it is not the <code>year</code>
variable alone driving poor estimation of the weights, however, the
proportional hazards assumption does not hold. We will therefore proceed
to estimate the weights using a flexible parametric model and evaluate
whether there are any differences.</p>
</div>
<div class="section level2">
<h2 id="flexible-parametric-model-for-estimating-the-inverse-probability-of-censoring-weights">Flexible parametric model for estimating the inverse probability of
censoring weights<a class="anchor" aria-label="anchor" href="#flexible-parametric-model-for-estimating-the-inverse-probability-of-censoring-weights"></a>
</h2>
<p>We start by defining a function which will estimate the weights using
a flexibe parametric survival model<span class="citation">(Royston and
Parmar 2002)</span> (implemented in R using
<strong>flexsurv</strong><span class="citation">(Jackson
2016)</span>).</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc_weights_flexsurv</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_ms</span>, <span class="va">data_raw</span>, <span class="va">covs</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">t</span>, <span class="va">s</span>, <span class="va">landmark_type</span> <span class="op">=</span> <span class="st">"state"</span>, <span class="va">j</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">max_weight</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">stabilised</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">max_follow</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">covs_tv</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="co">### Modify everybody to be censored after time t, if a max_follow has been specified</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">max_follow</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>    <span class="co">### Stop if max follow is smaller than t</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">max_follow</span> <span class="op">&lt;</span> <span class="va">t</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Max follow cannot be smaller than t"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">data_raw</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">data_raw</span>,</span>
<span>                                dtcens_s <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&lt;</span> <span class="va">max_follow</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">~</span> <span class="va">dtcens_s</span>,</span>
<span>                                                            <span class="va">dtcens</span> <span class="op">&gt;=</span> <span class="va">max_follow</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                dtcens <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&lt;</span> <span class="va">max_follow</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">~</span> <span class="va">dtcens</span>,</span>
<span>                                                          <span class="va">dtcens</span> <span class="op">&gt;=</span> <span class="va">max_follow</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">~</span> <span class="va">max_follow</span> <span class="op">+</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">### Create a new outcome, which is the time until censored from s</span></span>
<span>  <span class="va">data_raw</span><span class="op">$</span><span class="va">dtcens_modified</span> <span class="op">&lt;-</span> <span class="va">data_raw</span><span class="op">$</span><span class="va">dtcens</span> <span class="op">-</span> <span class="va">s</span></span>
<span></span>
<span>  <span class="co">### Save a copy of data_raw</span></span>
<span>  <span class="va">data_raw_save</span> <span class="op">&lt;-</span> <span class="va">data_raw</span></span>
<span></span>
<span>  <span class="co">### If landmark_type = "state", calculate weights only in individuals in state j at time s</span></span>
<span>  <span class="co">### If landmark_type = "all", calculate weights in all uncensored individuals at time s (note that this excludes individuals</span></span>
<span>  <span class="co">### who have reached absorbing states, who have been 'censored' from the survival distribution is censoring)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">landmark_type</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">### Identify individuals who are uncensored in state j at time s</span></span>
<span>    <span class="va">ids_uncens</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data_ms</span>, <span class="va">from</span> <span class="op">==</span> <span class="va">j</span> <span class="op">&amp;</span> <span class="va">Tstart</span> <span class="op">&lt;=</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">Tstop</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">landmark_type</span> <span class="op">==</span> <span class="st">"all"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co">### Identify individuals who are uncensored time s</span></span>
<span>    <span class="va">ids_uncens</span> <span class="op">&lt;-</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data_ms</span>, <span class="va">Tstart</span> <span class="op">&lt;=</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">Tstop</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">### Subset data_ms and data_raw to these individuals</span></span>
<span>  <span class="va">data_ms</span> <span class="op">&lt;-</span> <span class="va">data_ms</span> <span class="op">|&gt;</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_uncens</span><span class="op">)</span></span>
<span>  <span class="va">data_raw</span> <span class="op">&lt;-</span> <span class="va">data_raw</span> <span class="op">|&gt;</span> <span class="fu">base</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ids_uncens</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Assign degree of freedom for baseline hazard</span></span>
<span>  <span class="va">baseline_df</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span>  </span>
<span>  <span class="co">### Create formula for flexible parametric model</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"survival::Surv("</span>,</span>
<span>                           <span class="st">"dtcens_modified"</span>,</span>
<span>                           <span class="st">","</span>,</span>
<span>                           <span class="st">"dtcens_s"</span>,</span>
<span>                           <span class="st">") ~"</span>,</span>
<span>                           <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">covs</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">covs_tv</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cens_model</span> <span class="op">&lt;-</span> <span class="fu">flexsurv</span><span class="fu">::</span><span class="fu"><a href="http://chjackson.github.io/flexsurv-dev/reference/flexsurvspline.html" class="external-link">flexsurvspline</a></span><span class="op">(</span></span>
<span>      formula <span class="op">=</span> <span class="va">form</span>,</span>
<span>      data <span class="op">=</span> <span class="va">data_raw</span>,</span>
<span>      k <span class="op">=</span> <span class="va">baseline_df</span>,</span>
<span>      scale <span class="op">=</span> <span class="st">"hazard"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">covs_tv_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, length <span class="op">=</span> <span class="va">baseline_df</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">covs_tv_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">baseline_df</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>    <span class="va">covs_tv_list</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"gamma"</span>,</span>
<span>                   <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">baseline_df</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                   sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"~"</span>,</span>
<span>                                       <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">covs_tv</span><span class="op">)</span>,</span>
<span>                                             collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">cens_model</span> <span class="op">&lt;-</span> <span class="fu">flexsurv</span><span class="fu">::</span><span class="fu"><a href="http://chjackson.github.io/flexsurv-dev/reference/flexsurvspline.html" class="external-link">flexsurvspline</a></span><span class="op">(</span></span>
<span>      formula <span class="op">=</span> <span class="va">form</span>,</span>
<span>      anc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">covs_tv_list</span>, <span class="va">as.formula</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="va">data_raw</span>,</span>
<span>      k <span class="op">=</span> <span class="va">baseline_df</span>,</span>
<span>      scale <span class="op">=</span> <span class="st">"hazard"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">### Identify individuals who entered absorbing states or were censored prior to evaluation time</span></span>
<span>  <span class="va">obs_absorbed_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data_raw_save</span><span class="op">$</span><span class="va">dtcens</span> <span class="op">&lt;=</span> <span class="va">t</span> <span class="op">&amp;</span> <span class="va">data_raw_save</span><span class="op">$</span><span class="va">dtcens_s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">obs_censored_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">data_raw_save</span><span class="op">$</span><span class="va">dtcens</span> <span class="op">&lt;=</span> <span class="va">t</span> <span class="op">&amp;</span> <span class="va">data_raw_save</span><span class="op">$</span><span class="va">dtcens_s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">###</span></span>
<span>  <span class="co">### Now create unstabilised probability of (un)censoring weights</span></span>
<span>  <span class="co">### Note that weights are the probability of being uncensored, so if an individual has low probability of being uncesored,</span></span>
<span>  <span class="co">### the inervse of this will be big, weighting them strongly</span></span>
<span>  <span class="co">###</span></span>
<span></span>
<span>  <span class="co">### First etsimate all individuals a weight of the probability of being uncensored at time t</span></span>
<span>  <span class="va">data_raw_save</span><span class="op">$</span><span class="va">pcw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">cens_model</span>, newdata <span class="op">=</span> <span class="va">data_raw_save</span>, type <span class="op">=</span> <span class="st">"surv"</span>, times <span class="op">=</span> <span class="va">t</span> <span class="op">-</span> <span class="va">s</span><span class="op">)</span><span class="op">$</span><span class="va">.pred_survival</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### Now we must estimate survival probabilities at the times individuals entered absorbing states prior to t (t - s for landmarking)</span></span>
<span>  <span class="co">### Identify who these individuals are</span></span>
<span>  <span class="va">data_raw_absorbed_prior</span> <span class="op">&lt;-</span> <span class="va">data_raw_save</span><span class="op">[</span><span class="va">obs_absorbed_prior</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="co">### Estimate survival probability at time t (t - s for landmarking)</span></span>
<span>  <span class="va">data_raw_save</span><span class="op">$</span><span class="va">pcw</span><span class="op">[</span><span class="va">obs_absorbed_prior</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_raw_absorbed_prior</span><span class="op">)</span>,</span>
<span>                                                         <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">cens_model</span>,</span>
<span>                                                                                          newdata <span class="op">=</span> <span class="va">data_raw_absorbed_prior</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span>,</span>
<span>                                                                                          times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data_raw_absorbed_prior</span><span class="op">[</span><span class="va">x</span>, <span class="st">"dtcens_modified"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                                                                          type <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span>,</span>
<span>                                                                                  <span class="va">.pred_survival</span><span class="op">)</span><span class="op">}</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">### For individuals who were censored prior to t, assign the weight as NA</span></span>
<span>  <span class="va">data_raw_save</span><span class="op">$</span><span class="va">pcw</span><span class="op">[</span><span class="va">obs_censored_prior</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span>  <span class="co">### Invert these</span></span>
<span>  <span class="va">data_raw_save</span><span class="op">$</span><span class="va">ipcw</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="va">data_raw_save</span><span class="op">$</span><span class="va">pcw</span></span>
<span></span>
<span>  <span class="co">### Create output object</span></span>
<span>    <span class="va">data_raw_save</span><span class="op">$</span><span class="va">ipcw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">data_raw_save</span><span class="op">$</span><span class="va">ipcw</span>, <span class="va">max_weight</span><span class="op">)</span></span>
<span>    <span class="va">output_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"id"</span> <span class="op">=</span> <span class="va">data_raw_save</span><span class="op">$</span><span class="va">id</span>, <span class="st">"ipcw"</span> <span class="op">=</span> <span class="va">data_raw_save</span><span class="op">$</span><span class="va">ipcw</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">output_weights</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We then use this function to calculate the weights:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span><span class="op">$</span><span class="va">ipcw_fp</span> <span class="op">&lt;-</span> <span class="fu">calc_weights_flexsurv</span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>, </span>
<span>                                data_raw <span class="op">=</span> <span class="va">ebmtcal</span>, </span>
<span>                                covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>, </span>
<span>                                t <span class="op">=</span> <span class="va">t_eval</span>, s <span class="op">=</span> <span class="fl">0</span>, j <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                                max_follow <span class="op">=</span> <span class="va">t_eval</span><span class="op">)</span><span class="op">$</span><span class="va">ipcw</span></span></code></pre></div>
<p>We can view the distribution of these weights:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ipcw_fp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Removed 501 rows containing non-finite outside the scale range</span></span>
<span><span class="co">## (`stat_bin()`).</span></span></code></pre>
<p><img src="Sensitivity-analysis-for-IPCWs_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>We see there is very little difference compared to when the weights
were estimated using the cox-proportional hazards model.</p>
<p>Next we use this function to estimate the calibration curves. This is
implemented as the input to argument <code>w_function</code> in
<code>calib_msm</code>. The function <code>calc_weights_flexsurv</code>
also has an extra argument (<code>covs_tv</code>) compared to the
default function for estimating the weights (<code>calc_weights</code>).
This variable is used to specify the variables which are modelled as
time-varying coefficients (time-varying hazard ratio), wherein the
coefficient is modelled as a spline term (function uses 3 degrees of
freedom) as described in <span class="citation">Royston and Parmar
(2002)</span>. This variable should also be specified when running
<code>calib_msm</code>. For comparison, we plot the calibration curves
using the default internal approach (cox proportional hazards). First
estimate the calibration curves:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Define predicted transition probabilities out of state j = 1 at time s = 0</span></span>
<span><span class="va">tp_pred_s0</span> <span class="op">&lt;-</span> <span class="va">tps0</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">j</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">any_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"pstate"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### Estimate calibration curves</span></span>
<span></span>
<span><span class="co"># Default, coxph function for estimating the weights</span></span>
<span><span class="va">dat_calib_blr_coxph</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>            data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>            j<span class="op">=</span><span class="fl">1</span>,</span>
<span>            s<span class="op">=</span><span class="fl">0</span>,</span>
<span>            t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>            tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>            calib_type <span class="op">=</span> <span class="st">"blr"</span>,</span>
<span>            curve_type <span class="op">=</span> <span class="st">"rcs"</span>,</span>
<span>            rcs_nk <span class="op">=</span> <span class="fl">3</span>,</span>
<span>            w_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>            w_max_follow <span class="op">=</span> <span class="fl">1826</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using flexible parametric function for estimating the weights</span></span>
<span><span class="va">dat_calib_blr_flexsurv</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/calib_msm.html">calib_msm</a></span><span class="op">(</span>data_ms <span class="op">=</span> <span class="va">msebmtcal</span>,</span>
<span>            data_raw <span class="op">=</span> <span class="va">ebmtcal</span>,</span>
<span>            j<span class="op">=</span><span class="fl">1</span>,</span>
<span>            s<span class="op">=</span><span class="fl">0</span>,</span>
<span>            t <span class="op">=</span> <span class="va">t_eval</span>,</span>
<span>            tp_pred <span class="op">=</span> <span class="va">tp_pred_s0</span>,</span>
<span>            calib_type <span class="op">=</span> <span class="st">"blr"</span>,</span>
<span>            curve_type <span class="op">=</span> <span class="st">"rcs"</span>,</span>
<span>            rcs_nk <span class="op">=</span> <span class="fl">3</span>,</span>
<span>            w_covs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"agecl"</span>, <span class="st">"proph"</span>, <span class="st">"match"</span><span class="op">)</span>,</span>
<span>            w_function <span class="op">=</span> <span class="va">calc_weights_flexsurv</span>,</span>
<span>            w_max_follow <span class="op">=</span> <span class="fl">1826</span>,</span>
<span>            covs_tv <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Plot the calibration curves:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html" class="external-link">grid.draw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_blr_coxph</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<p class="caption">
BLR-IPCW calibration curves when using a cox proportional hazards model
to estimate the weights
</p>
<img src="Sensitivity-analysis-for-IPCWs_files/figure-html/unnamed-chunk-12-1.png" alt="BLR-IPCW calibration curves when using a cox proportional hazards model to estimate the weights" width="720">
</div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html" class="external-link">grid.draw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dat_calib_blr_flexsurv</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<p class="caption">
BLR-IPCW calibration curves when using a flexible parametric model to
estimate the weights
</p>
<img src="Sensitivity-analysis-for-IPCWs_files/figure-html/unnamed-chunk-13-1.png" alt="BLR-IPCW calibration curves when using a flexible parametric model to estimate the weights" width="720">
</div>
<p>There is very little difference, and the estimated calibration curves
are not very sensitive to the choice of model to estimate the inverse
probability of censoring weights. The difference between the BLR-IPCW
and pseudo-calibration curves is therefore unlikely to be driven by
this. We therefore turn our attention to the assumption that the outcome
and censoring distributions are conditionally independent given the
weights.</p>
</div>
<div class="section level2">
<h2 id="conditional-independence-of-the-censoring-mechanism-and-the-outcome-process">Conditional independence of the censoring mechanism and the outcome
process<a class="anchor" aria-label="anchor" href="#conditional-independence-of-the-censoring-mechanism-and-the-outcome-process"></a>
</h2>
<p>BLR-IPCW and MLR-IPCW approaches assume that the outcome,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>k</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">I_{k}(t)</annotation></semantics></math>,
is independent from the censoring mechanism in the re-weighted
population. This can be thought of as conditional independence between
the outcome and censoring mechanism given the weights. We will explore
this assumption with a number of steps.</p>
<div class="section level3">
<h3 id="exploration-of-the-rate-of-censoring-out-of-each-state">Exploration of the rate of censoring out of each state<a class="anchor" aria-label="anchor" href="#exploration-of-the-rate-of-censoring-out-of-each-state"></a>
</h3>
<p>We start by looking at all individuals that pass through states 1, 2,
3 and 4, and see what proportion of individuals remain in these states
until they are censored:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    prop.cens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">ae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rec.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">recae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      n prop.cens</span></span>
<span><span class="co">## 1 2279 0.1456779</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rec.s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    prop.cens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">recae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      n prop.cens</span></span>
<span><span class="co">## 1 1218 0.3341544</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ae.s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    prop.cens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">recae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      n prop.cens</span></span>
<span><span class="co">## 1 1134 0.1948854</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">recae.s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    prop.cens <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     n prop.cens</span></span>
<span><span class="co">## 1 660  0.630303</span></span></code></pre>
<p>We see far fewer individuals remain in the adverse event state (19%)
until they are censored compared to the other states (33.4% and 63.3%).
However, it’s difficult to interpret these, as censoring is heavily
impacted by the competing risks of other events.</p>
<p>A more information measure is to look at the proportion of
individuals that are censored in each state, that are censored within
5-years.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rec.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">recae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, mean.fup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span><span class="op">)</span>,</span>
<span>            mean.fup.lower.1826 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&lt;</span> <span class="fl">1826</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     n mean.fup mean.fup.lower.1826</span></span>
<span><span class="co">## 1 332 2392.286           0.3795181</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rec.s</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">recae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, mean.fup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span><span class="op">)</span>,</span>
<span>            mean.fup.lower.1826 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&lt;</span> <span class="fl">1826</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     n mean.fup mean.fup.lower.1826</span></span>
<span><span class="co">## 1 407 2259.007           0.4152334</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ae.s</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">recae.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, mean.fup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span><span class="op">)</span>,</span>
<span>            mean.fup.lower.1826 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&lt;</span> <span class="fl">1826</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     n mean.fup mean.fup.lower.1826</span></span>
<span><span class="co">## 1 221 3082.977           0.1764706</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">recae.s</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">srv.s</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">&amp;</span> <span class="va">rel.s</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, mean.fup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span><span class="op">)</span>,</span>
<span>            mean.fup.lower.1826 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">dtcens</span> <span class="op">&lt;</span> <span class="fl">1826</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     n mean.fup mean.fup.lower.1826</span></span>
<span><span class="co">## 1 416 2366.279           0.3894231</span></span></code></pre>
<p>We see that of individuals that are censored in states 1, 2 and 4,
about 40% of these are censored prior to 5-years. However, for
individuals that are censored in the adverse event state (state 3), only
17.6% of these are censored within 5-years. So in the data, we are
seeing that individuals that remain in the adverse event state, are less
likely to be censored. While we cannot fully understand the data
observation process, it is not a stretch to imagine individuals who had
had an adverse event, and not recovered, would be monitored for longer
periods of time, resulting in fewer being censored within 5-years.</p>
</div>
<div class="section level3">
<h3 id="is-this-differential-censoring-driven-by-differences-in-baseline-predictors">Is this differential censoring driven by differences in baseline
predictors?<a class="anchor" aria-label="anchor" href="#is-this-differential-censoring-driven-by-differences-in-baseline-predictors"></a>
</h3>
<p>At this point, we should consider the possibility that year was
highly predictive of adverse event, and we know that year is highly
predictive of follow up time too. In this case, the relationship would
be explained by a variable available at baseline, however, we see that
adverse events are quite similar across different year categories:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ae.s</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">##   year      `mean(ae.s)`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> 1985-1989        0.475</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> 1990-1994        0.522</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> 1995-1998        0.487</span></span></code></pre>
<p>We also look at the distribution of the other variables across those
who do and do not have an adverse event.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">agecl</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ae.s</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">##   agecl `mean(ae.s)`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> &lt;=20         0.445</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> 20-40        0.514</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> &gt;40          0.517</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">proph</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ae.s</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">##   proph `mean(ae.s)`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> no           0.520</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> yes          0.428</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">match</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ae.s</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">##   match              `mean(ae.s)`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> no gender mismatch        0.499</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> gender mismatch           0.492</span></span></code></pre>
<p>It is therefore looking like this cannot be explained by information
available at baseline.</p>
</div>
<div class="section level3">
<h3 id="distribution-of-weights-by-outcome-state-at-5-years">Distribution of weights by outcome state at 5-years<a class="anchor" aria-label="anchor" href="#distribution-of-weights-by-outcome-state-at-5-years"></a>
</h3>
<p>If individuals in state 3 are less likely to be censored than those
in states 1, 2 and 4, then individuals who have spent a long time in
state 3 do not need to be upweighted as much. Using the inverse
probability of censoring weights estimated earlier, we take the mean
weight, grouped by the outcome state individuals are in at 5-years.</p>
<p>We start by identifying which state each individual is in at
5-years.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Extract which state individuals are in at time t</span></span>
<span><span class="va">ids_state_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">ids_state_list</span><span class="op">[[</span><span class="va">k</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">calibmsm</span><span class="fu">:::</span><span class="fu">extract_ids_states</span><span class="op">(</span><span class="va">msebmtcal</span>, tmat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html" class="external-link">attributes</a></span><span class="op">(</span><span class="va">msebmtcal</span><span class="op">)</span><span class="op">$</span><span class="va">trans</span>, <span class="va">k</span>, <span class="va">t_eval</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">### Create a variable to say which state an individual was in at the time of interest</span></span>
<span><span class="co">## Create list containing the relevant data</span></span>
<span><span class="va">v1</span> <span class="op">&lt;-</span> <span class="va">ebmtcal</span><span class="op">$</span><span class="va">id</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">v1</span>, <span class="va">ids_state_list</span>, FUN <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Vectorize.html" class="external-link">Vectorize</a></span><span class="op">(</span><span class="st">'%in%'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">state_poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">m1</span>, <span class="fu"><a href="https://rdrr.io/r/base/row.html" class="external-link">row</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Change integer(0) values to NA's</span></span>
<span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">state_poly</span>, <span class="va">length</span><span class="op">)</span></span>
<span><span class="va">state_poly</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co">## Add to ebmtcal</span></span>
<span><span class="va">ebmtcal</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">ebmtcal</span>, state_poly <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">state_poly</span><span class="op">)</span>,</span>
<span>                          state_poly_fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state_poly</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Then calculate mean weight within each group:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebmtcal</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">state_poly</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_weight <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ipcw_ph</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 7 × 2</span></span></span>
<span><span class="co">##   state_poly mean_weight</span></span>
<span><span class="co">##        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>          1        1.32</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>          2        1.52</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>          3        1.47</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>          4        1.64</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>          5        1.05</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>          6        1.03</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span>         <span style="color: #BB0000;">NA</span>       <span style="color: #BB0000;">NA</span></span></span></code></pre>
<p>Given the differential rate of censoring within 5-years (17% vs 40%),
we would require weights for individuals in state 3 at 5-years to be
considerably lower than for states 1, 2 and 4. Note that this is only a
proxy, as individuals in state 4 may have spent some time in state 3,
however, we would expect bigger differences than what is observed here.
It is therefore likely that the inverse probability of censoring weights
are incorrect, however, not due to a violation of the proportional
hazards assumption as previously thought.</p>
<p>The BLR-IPCW and MLR-IPCW approaches assume conditional independence
between the outcome and censoring distribution given the weights. This
is the underlying assumption upon which inverse probability of censoring
is based. So far, we have proposed estimating the weights conditional on
a vector of covariates collected at baseline, Z. When the weights are
estimated by modelling the time until censoring conditional on a vector
of baseline covariates <strong>Z</strong>, this effectively becomes
conditional independence given (a function of) <strong>Z</strong>.
Indeed, if this assumption holds, the proposed methodology works fine,
as was shown trough simulations.<span class="citation">(Pate et al.
2024)</span> However, something that has not been considered is when the
censoring mechanism changes depending on which state an individual is
in. In this setting, conditional dependence between the outcome and the
censoring mechanism given weights estimated from baseline covariates
alone may be hard to achieve, unless the baseline covariates are highly
predictive of the states upon which individuals will enter. We believe
this is likely happening in this setting. It’s possible this could be
mitigated by using more complex models to estimate the IPCWs, such as a
latent class model, where the probability of censoring is dependent on
the outcome state that an individual is in. However, much deeper thought
is required around this notion, and simulation studies would be required
to establish the performance of such an approach. Note that when the
probability of censoring changes depending on the outcome state an
individual is present in, we do not believe this will violate the
assumption of the Aalen-Johansen estimator, which require “subjects who
are censored at time t should be representative of all the study
subjects who remained at risk at time t with respect to their survival
experience”.<span class="citation">(Kleinbaum and Klein 2012)</span>.
However, again, it would be beneficial to establish this through a
simulation study.</p>
<p>For now, we would like to emphasise to users that in order to
implement the BLR-IPCW and MLR-IPCW approaches, it is essential for the
outcome and censoring mechanism to be conditionally independent given
some set of baseline covariates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐙</mi><annotation encoding="application/x-tex">\mathbf{Z}</annotation></semantics></math>,
whether this is via the weighting in IPCW, or the grouping in the
pseudo-value approach. If the censoring probability, or observation
process, changes depending on the outcome state that an individuals is
in, this can cause bias in the estimation of the calibration curves
unless properly accounted for when estimating the weights.</p>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Jackson2016" class="csl-entry">
Jackson, Christopher H. 2016. <span>“<span class="nocase">Flexsurv: A
platform for parametric survival modeling in R</span>.”</span>
<em>Journal of Statistical Software</em> 70 (8). <a href="https://doi.org/10.18637/jss.v070.i08" class="external-link">https://doi.org/10.18637/jss.v070.i08</a>.
</div>
<div id="ref-Kleinbaum2012" class="csl-entry">
Kleinbaum, David G., and Mitchel Klein. 2012. <em><span>Survival
Analysis: A Self-Learning Text</span></em>. 3rd ed. Springer. <a href="https://doi.org/10.1007/978-1-4419-6646-9" class="external-link">https://doi.org/10.1007/978-1-4419-6646-9</a>.
</div>
<div id="ref-Pate2024" class="csl-entry">
Pate, Alexander, Matthew Sperrin, Richard D. Riley, Niels Peek, Tjeerd
Van Staa, Jamie C. Sergeant, Mamas A. Mamas, et al. 2024. <span>“<span class="nocase">Calibration plots for multistate risk predictions
models</span>.”</span> <em>Statistics in Medicine</em>, no. April: 1–23.
<a href="https://doi.org/10.1002/sim.10094" class="external-link">https://doi.org/10.1002/sim.10094</a>.
</div>
<div id="ref-Royston2002" class="csl-entry">
Royston, Patrick, and Mahesh K. B. Parmar. 2002. <span>“<span class="nocase">Flexible parametric proportional-hazards and
proportional-odds models for censored survival data, with application to
prognostic modelling and estimation of treatment effects</span>.”</span>
<em>Statistics in Medicine</em> 21 (15): 2175–97. <a href="https://doi.org/10.1002/sim.1203" class="external-link">https://doi.org/10.1002/sim.1203</a>.
</div>
<div id="ref-DeWreede2011" class="csl-entry">
Wreede, Liesbeth C de, Marta Fiocco, and Hein Putter. 2011. <span>“<span class="nocase">mstate: An R Package for the Analysis of Competing Risks
and Multi-State Models</span>.”</span> <em>Journal of Statistical
Software</em> 38 (7). <a href="https://cran.r-project.org/package=mstate" class="external-link">https://cran.r-project.org/package=mstate</a>.
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Alexander Pate, Glen P Martin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
